<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 해당 파일에 모든 쿼리문을 작성 -->
<mapper namespace="board">
    <resultMap id="boardMap" type="com.green.Team3.board.vo.BoardVO">
        <id column="BOARD_NUM"                   property="boardNum"/>
        <result column="BOARD_TITLE"             property="boardTitle"/>
        <result column="BOARD_CONTENT"           property="boardContent"/>
        <result column="MEMBER_ID"               property="memberId"/>
        <result column="TYPE_NUM"                property="typeNum"/>
        <result column="BOARD_CNT"               property="boardCnt"/>
        <collection property="imgList"           resultMap="img"/>
    </resultMap>

    <resultMap id="boardTypeMap" type="com.green.Team3.board.vo.BoardTypeVO">
        <id column="TYPE_NUM"                    property="typeNum"/>
        <result column="TYPE_NAME"               property="typeName"/>
    </resultMap>

    <resultMap id="img" type="com.green.Team3.board.vo.ImgVO">
        <id column="IMG_NUM"                     property="imgNum"/>
        <result column="ORIGIN_FILE_NAME"        property="originFileName"/>
        <result column="ATTACHED_FILE_NAME"      property="attachedFileName"/>
        <result column="IS_MAIN"                 property="isMain"/>
        <result column="BOARD_NUM"               property="boardNum"/>
    </resultMap>


<!--  [ 공지사항 & 문의사항 게시판 관련 ]  -->

    <!-- 다음에 INSERT 할 게시물 BOARD_NUM 조회 -->
    <select id="selectNextNoticeCode" resultType="int">
        SELECT IFNULL(MAX(BOARD_NUM), 0) + 1
        FROM BOARD
    </select>

    <!-- 게시물 목록 조회 -->
    <!-- 이너조인 memberRoll 가져오기-->
    <select id="selectNoticeList" resultMap="boardMap">
        SELECT BOARD_NUM
            , BOARD_TITLE
            , BOARD_CONTENT
            , B.MEMBER_ID
            , TYPE_NUM
            , BOARD_CNT
            , MEMBER_ROLL
        FROM BOARD B
        INNER JOIN MEMBER M
        ON B.MEMBER_ID = M.MEMBER_ID
        <if test='searchValue != null and !searchValue.equals("")'>
            WHERE ${searchType} LIKE CONCAT('%', #{searchValue}, '%')
        </if>
        ORDER BY BOARD_NUM DESC
        LIMIT ${displayDataCnt} OFFSET ${displayDataCnt * (nowPage - 1)}
    </select>

    <!-- 게시글 작성 - 공지사항 -->
    <insert id="insertNotice">
        INSERT INTO BOARD (
            BOARD_TITLE
            , BOARD_CONTENT
            , MEMBER_ID
            , TYPE_NUM
        ) VALUES (
            #{boardTitle}
            , #{boardContent}
            , #{memberId}
            , #{typeNum}
        )
    </insert>

    <!-- 게시글 작성 - 문의사항 -->
    <insert id="insertQna">
        INSERT INTO BOARD (
        BOARD_TITLE
        , BOARD_CONTENT
        , MEMBER_ID
        , TYPE_NUM
        ) VALUES (
        #{boardTitle}
        , #{boardContent}
        , #{memberId}
        , #{typeNum}
        )
    </insert>

    <!-- 게시글 상세 조회 -->
    <select id="selectNoticeDetail" resultMap="boardMap">
        SELECT BOARD_NUM
            , BOARD_TITLE
            , BOARD_CONTENT
            , MEMBER_ID
            , TYPE_NUM
            , BOARD_CNT
        FROM BOARD
        WHERE BOARD_NUM = #{boardNum}
    </select>

    <!-- 게시글 조회수 증가 -->
    <update id="updateBoardCnt">
        UPDATE BOARD
        SET
            BOARD_CNT = BOARD_CNT + 1
        WHERE BOARD_NUM = #{boardNum}
    </update>

    <!-- 게시글 삭제 -->
    <delete id="deleteNotice">
        DELETE FROM BOARD
        WHERE BOARD_NUM = #{boardNum}
    </delete>

    <!-- 게시글 수정 -->
    <update id="updateBoard">
        UPDATE BOARD
        SET
            BOARD_TITLE = #{boardTitle}
            , BOARD_CONTENT = #{boardContent}
        WHERE BOARD_NUM = #{boardNum}
    </update>

    <!-- 게시글 갯수 조회 -->
    <!--  *****공지/문의 분리해서 조회해야함  -->
    <select id="selectNoticeCnt" resultType="int">
        SELECT COUNT(BOARD_NUM)
        FROM BOARD
        <if test='searchValue != null and !searchValue.equals("")'>
            WHERE ${searchType} LIKE CONCAT('%', #{searchValue}, '%')
        </if>
    </select>

    <!-- 게시글 상세 - 이전글 / 다음글 조회 -->
    <!-- LAG : 기준 데이터의 이전 행의 값을 반환 -->
    <!-- LEAD : 기준 데이터의 다음 행의 값을 반환 -->
    <!-- SELECT 조회할 컬럼명 LAG(대상 컬럼명) OVER (ORDER BY 대상 컬럼명 정렬기준) AS 별칭 FROM 테이블명
         SELECT 조회할 컬럼명 LEAD(대상 컬럼명) OVER (ORDER BY 대상 컬럼명 정렬기준) AS 별칭 FROM 테이블명 -->
    <!--  SELECT *
            FROM (SELECT
                         글 번호
                        BOARD_NUM
                         prevNum : 이전글 / nextNum : 다음글
                        , LAG(BOARD_NUM, 1, -1) OVER(ORDER BY BOARD_NUM ASC) AS prevNum
                        , LEAD(BOARD_NUM, 1, -1) OVER(ORDER BY BOARD_NUM ASC) AS nextNum
                         글 제목
                        , BOARD_TITLE
                        , LAG(BOARD_TITLE, 1, -1) OVER(ORDER BY BOARD_NUM ASC) AS prevTitle
                        , LEAD(BOARD_TITLE, 1, -1) OVER(ORDER BY BOARD_NUM ASC) AS nextTitle
                FROM BOARD
                ORDER BY BOARD_NUM DESC)
            WHERE BOARD_NUM = #{boardNum}  -->

    <!-- 게시글 상세 - 이전글 조회 -->
    <select id="prevPage" resultMap="boardMap" resultType="int">
        SELECT BOARD_NUM
            , BOARD_TITLE
        FROM BOARD
        WHERE ${currentBoardNum} > BOARD_NUM
        ORDER BY BOARD_NUM DESC
        LIMIT 1;
    </select>

    <!-- 게시글 상세 - 다음글 조회 -->
    <select id="nextPage" resultMap="boardMap" resultType="int">
        SELECT BOARD_NUM
                , BOARD_TITLE
        FROM BOARD
        WHERE BOARD_NUM > #{currentBoardNum}
        ORDER BY BOARD_NUM ASC
        LIMIT 1;
    </select>

    <!-- 공지사항 게시글 이미지 파일 첨부 -->
    <insert id="insertImgs">
        INSERT INTO BOARD_IMAGE (
            ORIGIN_FILE_NAME
            , ATTACHED_FILE_NAME
            , IS_MAIN
            , BOARD_NUM
        ) VALUES
        <foreach collection="imgList" item="img" separator=",">
            (
                #{img.originFileName}
                , #{img.attachedFileName}
                , #{img.isMain}
                , #{img.boardNum}
            )
        </foreach>
    </insert>



</mapper>































