<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 해당 파일에 모든 쿼리문을 작성 -->
<mapper namespace="testMapper">



    <resultMap id="testResult" type="com.green.Team3.test.vo.TestVO">
        <id column="TEST_NUM" property="testNum"/>
        <result column="TEST_NAME" property="testName"/>
        <result column="TEST_DATE" property="testDate"/>
        <result column="TEST_MAXSCORE" property="testMaxScore"/>
        <result column="CLASS_NUM" property="classNum"/>
        <collection property="studentListVO" resultMap="admin.operator"/>
    </resultMap>

    <resultMap id="scoreResult" type="com.green.Team3.test.vo.TestScoreVO">
    <id column="SCORE_NUM" property="scoreNum"/>
    <result column="SCORE" property="score"/>
    <result column="TEST_NUM" property="testNum"/>
    <result column="MEMBER_ID" property="memberId"/>
    <result column="RANKING" property="ranking"/>
    <result column="SUB_TEST_NUM" property="subTestNum"/>
    <association property="memberOneVO" resultMap="member.memberMap"/>
    <association property="testOneVo" resultMap="testResult"/>
    <association property="testSubOneVO" resultMap="subResult"/>
    </resultMap>

    <resultMap id="subResult" type="com.green.Team3.test.vo.TestSubjectVO">
        <id column="SUB_TEST_NUM"       property="subTestNum" />
        <result column="SUB_NAME"           property="subName" />
        <result column="SUB_MAXSCORE"       property="subMaxScore" />
        <result column="TEST_NUM"           property="testNum" />
        <association property="testOneVO"      resultMap="testResult"/>
    </resultMap>

<!-- /////////////////////////////////////// 강사가 로그인해서 성적 처리 관리 ////////////////////////////////////////////  -->
    <!-- 강사의 강의목록 조회   -->
    <select id="selectTeacherClassList" resultMap="clsMapper.cls">
        SELECT T.MEMBER_ID
        , MEMBER_NAME
        , T.TEACHER_NUM
        , CLASS_NAME
        , CLS.CLASS_NUM
        , TEACHER_WORK
        , CLASS_SDATE
        , CLASS_EDATE
        , CLASS_ENTER
        , (SELECT COUNT(O.MEMBER_ID)
        FROM operator O
        INNER JOIN MEMBER
        ON MEMBER.MEMBER_ID = O.MEMBER_ID
        WHERE O.CLASS_NUM = CLS.CLASS_NUM) AS STU_CNT
        , CLASS_PERSONNEL
        , CASE
        WHEN CLASS_EDATE &gt;= NOW() THEN '강의 중'
        ELSE '종료'
        END AS STR_WORK
        FROM CLASS_INFO CLS INNER JOIN TEACHER T
        ON CLS.TEACHER_NUM = T.TEACHER_NUM
        INNER JOIN MEMBER M
        ON T.MEMBER_ID = M.MEMBER_ID
        WHERE T.MEMBER_ID = #{memberId}
        ORDER BY CLASS_SDATE DESC
    </select>


    <!--   평가명 목록조회 -->
    <select id="selectTest" resultMap="testResult">
        SELECT
        TEST_NAME
        , TEST_DATE
        , TEST_MAXSCORE
        , CLASS_NUM
        , TEST_NUM
        FROM TEST
        WHERE CLASS_NUM = #{classNum}
        ORDER BY TEST_NUM DESC
    </select>



    <!-- 평가명 추가   -->
    <insert id="insertTest">
        INSERT INTO test (
        TEST_NAME
        , TEST_DATE
        , TEST_MAXSCORE
        , CLASS_NUM
        )VALUES(
        #{testName}
        , #{testDate}
        , #{testMaxScore}
        , #{classNum}
        )
    </insert>

    <!-- /////////////////////////////////////////////////-->
    <!-- CLASS_NUM 으로 받는  학생이름 조회  -->
    <select id="selectStuName" resultMap="member.memberMap">
        SELECT
        MEM.MEMBER_ID
        , MEMBER_NAME
        , OP.CLASS_NUM
        FROM member MEM
        INNER JOIN operator OP
        ON MEM.MEMBER_ID=OP.MEMBER_ID
        WHERE OP.CLASS_NUM= #{classNum}
        ORDER BY MEM.MEMBER_NAME ASC
    </select>

    <!--  테스트 목록에서 조회. 등록버튼 클릭시 학생 성적 조회  -->
    <select id="selectTestScore" resultMap="scoreResult">
        SELECT
        TS.TEST_NUM
        ,TEST_NAME
        , SCORE
        , TS.MEMBER_ID
        , MEMBER_NAME
        , TEST_MAXSCORE
        , SCORE_NUM
        , CLASS_NUM
        , DENSE_RANK()
        OVER (ORDER BY SCORE DESC) AS RANKING
        FROM test_score TS
        INNER JOIN test TT
        ON TS.TEST_NUM= TT.TEST_NUM
        INNER JOIN member MEM
        ON MEM.MEMBER_ID=TS.MEMBER_ID
        WHERE TS.TEST_NUM= #{testNum}

    </select>

    <!--  성적 등록 버튼 틀릭 시 저장 -->
    <insert id="insertStuScore">
        INSERT INTO TEST_SCORE (
        SCORE
        , TEST_NUM
        , MEMBER_ID
        )SELECT
        #{score}
        , #{testNum}
        , #{memberId}
        FROM DUAL
        WHERE NOT EXISTS(
        SELECT
        TEST_NUM
        , MEMBER_ID
        FROM test_score
        WHERE TEST_NUM=#{testNum} AND MEMBER_ID=#{memberId}
        )
    </insert>


    <!-- ////////////// 시험 성적 통계 조회 ////////////////////////// -->
    <!--classNum으로 받는  반 학생들 성적조회  -->
<!--    <select id="totalStuScoreSelect" resultMap="scoreResult">-->
<!--        SELECT-->
<!--        MEMBER_ID-->
<!--        , TT.TEST_NUM-->
<!--        , SCORE-->
<!--        , TT.CLASS_NUM-->
<!--        FROM test_score TS-->
<!--        INNER JOIN test TT-->
<!--        ON TS.TEST_NUM = TT.TEST_NUM-->
<!--        WHERE TT.CLASS_NUM = #{classNum}-->
<!--        ORDER BY TEST_NUM ASC-->
<!--    </select>-->

<!--    &lt;!&ndash;  시험명  &ndash;&gt;-->
<!--    <select id="totalTestSelect" resultMap="testResult">-->
<!--        SELECT-->
<!--        TEST_NUM-->
<!--        , TEST_NAME-->
<!--        , CLASS_NUM-->
<!--        FROM test-->
<!--        WHERE CLASS_NUM = #{classNum}-->
<!--        ORDER BY TEST_NUM ASC-->
<!--    </select>-->



    <!--  성적 등록 란에서 학생명, 시험지명 조회만   -->
    <select id="memNumInfo" resultMap="member.memberMap">
        SELECT
        MEM.MEMBER_ID
        , MEMBER_NAME
        , TT.CLASS_NUM
        , TT.TEST_NUM
        , TEST_NAME
        FROM member MEM
        INNER JOIN operator OP
        ON MEM.MEMBER_ID= OP.MEMBER_ID
        INNER JOIN test TT
        ON OP.CLASS_NUM= TT.CLASS_NUM
        WHERE TT.TEST_NUM= #{testNum}
        ORDER BY MEM.MEMBER_NAME ASC
    </select>

    <!--   테스트넘버 쓸려고..성적입력페이지에서     -->
    <select id="testNumInfo" resultMap="testResult">
        SELECT
            TEST_NUM
            ,TEST_NAME
            , CLASS_NUM
            , TEST_MAXSCORE
            ,TEST_DATE
        FROM test
        WHERE test_NUM =#{testNum}

    </select>

    <!--   클래스넘버 쓸려고..성적입력페이지에서     -->

    <select id="onlyClassNum" resultMap="clsMapper.cls">
        SELECT
         CLASS_NUM
        , CLASS_NAME
        FROM CLASS_INFO
        WHERE CLASS_NUM=#{classNum}
    </select>


    <!--  점수 수정 업데이트   -->

    <update id="updateScore"  parameterType="java.util.List" >

        UPDATE test_score
        SET
        SCORE = #{score}
        WHERE Score_Num= #{scoreNum}

    </update>



    <!-- 테스트 검색란  -->
    <select id="searchTestList" resultMap="testResult">
        SELECT
        TEST_NUM
        , TEST_NAME
        , CLASS_NUM
        , TEST_DATE
        , TEST_MAXSCORE
        FROM test
        WHERE 1=1
        AND CLASS_NUM= #{classNum}
        <if test='searchValue != null and !searchValue.equals("")'>
            AND ${searchTestType} LIKE CONCAT ('%',#{searchValue},'%')
        </if>
        <if test='searchFromDate !=null and !searchFromDate.equals("")'>
            AND DATE_FORMAT(TEST_DATE,'%Y-%m-%d') &gt;= #{searchFromDate}
        </if>
        <if test='searchToDate!=null and !searchFromDate.equals("")'>
            AND DATE_FORMAT(TEST_DATE,'%Y-%m-%d') &lt;= #{searchToDate}
        </if>
        ORDER BY TEST_DATE DESC
    </select>




<!-- ///////////////////////////////////////////////////////////////// -->
    <!-- sub 정보가 있으면  sub 입력페이지 이동 -->
    <select id="subSelect" resultMap="subResult">
        SELECT
        SUB_TEST_NUM
        , TEST_NUM
        , SUB_NAME
        FROM test_subject
        WHERE test_NUM=#{testNum}
    </select>

    <!--   학생수 계산하기  -->
    <select id="stuCnt" resultMap="member.memberMap">
        SELECT
            MEM.MEMBER_ID,
            MEMBER_NAME,
            CLASS_NUM,
            MEM.MEMBER_ID
        FROM member MEM
        INNER JOIN operator OP
        ON MEM.MEMBER_ID=OP.MEMBER_ID
        WHERE OP.CLASS_NUM= #{classNum}
    </select>


<!-- 과목있음 선택시 테스트명, 날짜만 저장 -->
    <insert id="subMainTestInsert">
        INSERT INTO test (
        TEST_NAME
        , TEST_DATE
        , CLASS_NUM
        )VALUES(
        #{testName}
        , #{testDate}
        , #{classNum}
        )
    </insert>



    <!--  과목저장  -->
    <insert id="insertSub">
        INSERT INTO TEST_SUBJECT(
        SUB_NAME
        , SUB_MAXSCORE
        , TEST_NUM
        )VALUES(
        #{subName}
        ,#{subMaxScore}
        ,#{testNum}
        )
    </insert>

    <!--  과목목록 조회  -->

    <select id="selectSubList" resultMap="subResult">
        SELECT
        SUB_TEST_NUM
        , TEST_NUM
        , SUB_NAME
        , SUB_MAXSCORE
        FROM test_subject
        WHERE test_NUM=#{testNum}
    </select>



    <!--  과목별 저장   -->
    <!--  성적 등록 버튼 틀릭 시 저장 -->
    <insert id="insertSubScore">
        INSERT INTO TEST_SCORE(
        SCORE
        , TEST_NUM
        , MEMBER_ID
        , SUB_TEST_NUM
        )VALUES(
        #{score}
        , #{testNum}
        , #{memberId}
        , #{subTestNum}
        )
    </insert>

    <!--   모달 과목저장할때 테스트넘버 쓸려고..    -->
    <select id="testNumInfo2" resultMap="testResult">
        SELECT
        TEST_NUM
        ,TEST_NAME
        , CLASS_NUM
        , TEST_MAXSCORE
        ,TEST_DATE
        FROM test
        WHERE test_NUM =#{testNum}
    </select>


<!--  /////////////////////////////  -->


        <!--  과목 한개 정보 조회  -->
       <select id="selectSubOne" resultMap="subResult">
           SELECT
           SUB_NAME
           , SUB_MAXSCORE
           , SUB_TEST_NUM
           FROM test_subject
           WHERE SUB_TEST_NUM=#{subTestNum}
       </select>


    <!--  메인 테스트 상세정보 변경1  -->
        <update id="updateTestDetail">
            UPDATE TEST
            SET
                TEST_NAME= #{testName}
                , TEST_DATE=#{testDate}
                , TEST_MAXSCORE=#{testMaxScore}
            WHERE TEST_NUM=#{testNum}
        </update>

    <!--  메인 테스트 상세정보 변경2  -->
    <update id="updateTestDeTwo">
        UPDATE TEST
        SET
        TEST_NAME= #{testName}
        , TEST_DATE=#{testDate}
        WHERE TEST_NUM=#{testNum}
    </update>




        <!--  과목 상세정보 변경  -->
    <update id="updateSubDetail">
        UPDATE test_subject
        SET
        SUB_NAME = #{subName}
        , SUB_MAXSCORE =#{subMaxScore}
        WHERE SUB_TEST_NUM=#{subTestNum}
    </update>



    <!--  // //////////////////////////// 학생이 로그인해서 본인 성적 조회 ////////////////////////////////////////////-->
    <!--  학생이 본인 성적 조회  -->
    <select id="selectStuTest" resultMap="member.memberMap">
        SELECT
        MEM.MEMBER_ID
        , MEMBER_NAME
        , MEMBER_ROLL
        FROM member MEM
        INNER JOIN operator OP
        ON MEM.MEMBER_ID=OP.MEMBER_ID
        WHERE OP.MEMBER_ID= #{memberId}
    </select>

    <!--학생 수강별조회 서비스-->
    <select id="selectStuCLTest" resultMap="testResult">
        SELECT
        OP.CLASS_NUM
        , CLASS_NAME
        , CLASS_ENTER
        , CLASS_SDATE
        , CLASS_EDATE
        , MEMBER_ID
        , TEST_NUM
        ,TEST_NAME
        , TEST_DATE
        , TEST_MAXSCORE
        FROM test TT
        INNER JOIN operator OP
        ON TT.CLASS_NUM=OP.CLASS_NUM
        INNER JOIN class_information CI
        ON OP.CLASS_NUM=CI.CLASS_NUM
        WHERE OP.MEMBER_ID=#{memberId}
    </select>


    <!-- 학생 시험별  과목수 조회 서비스   -->

    <select id="selectStuTestDetail" resultMap="testResult">
        SELECT
        TT.TEST_NUM
        , TEST_NAME
        , TEST_MAXSCORE
        , TEST_DATE
        , OP.MEMBER_ID
        , (SELECT COUNT(SUB_NAME)  FROM test_subject WHERE TEST_NUM = TT.TEST_NUM) AS SUB_CNT
        FROM test TT
        INNER JOIN operator OP
        ON TT.CLASS_NUM=OP.CLASS_NUM
        WHERE OP.MEMBER_ID=#{memberId}
    </select>

    <!-- 과목별 학생 성적 조회 -->
    <select id="selectStuSub" resultMap="subResult">
        SELECT
        SUB_TEST_NUM
        , SUB_NAME
        , SUB_MAXSCORE
        , TT.TEST_NUM
        , TEST_NAME
        , TEST_DATE
        FROM test_subject TS
        INNER JOIN test TT
        ON TS.TEST_NUM=TT.TEST_NUM
        INNER JOIN operator OP
        ON TT.CLASS_NUM=OP.CLASS_NUM
        WHERE OP.MEMBER_ID=#{memberId}
        ORDER BY TEST_NAME ASC
    </select>

    <!--  학생 전체 성적이수표 조회   -->

    <select id="totalSelectTest" resultMap="admin.operator">
        SELECT
        OP.CLASS_NUM
        , CLASS_NAME
        , CLASS_ENTER
        , MEMBER_ID
        , CLASS_SDATE
        , CLASS_EDATE
        FROM operator OP
        INNER JOIN class_information CI
        ON OP.CLASS_NUM=CI.CLASS_NUM
        WHERE OP.MEMBER_ID=#{memberId}
    </select>

    <!--    과목 없을시   my 성적페이지 이동 & 조회 -->
    <select id="mainTestMyScore" resultMap="scoreResult">
        SELECT
        TS.TEST_NUM
        ,TEST_NAME
        ,TEST_DATE
        , SCORE
        , TS.MEMBER_ID
        , TEST_MAXSCORE
        , SCORE_NUM
        , (SELECT COUNT(SUB_NAME)  FROM test_subject WHERE TEST_NUM = TS.TEST_NUM) AS SUB_CNT
        , (SELECT AVG (SCORE) FROM test_score WHERE TEST_NUM=TS.TEST_NUM) AS TEST_AVG
        FROM test_score TS
        INNER JOIN test TT
        ON TS.TEST_NUM= TT.TEST_NUM
        WHERE TS.TEST_NUM= #{testNum} AND TS.MEMBER_ID=#{memberId}
    </select>
    <!--    과목 있을시   my 성적페이지 이동 & 조회 -->
    <select id="subTestMyScore" resultMap="scoreResult">
        SELECT
        TB.TEST_NUM
        ,TEST_NAME
        , TEST_DATE
        , SCORE
        , TS.MEMBER_ID
        , TEST_MAXSCORE
        , SCORE_NUM
        , TB.SUB_TEST_NUM
        , SUB_NAME
        , SUB_MAXSCORE
        , (SELECT AVG (SCORE) FROM test_score TS WHERE TS.SUB_TEST_NUM=TB.SUB_TEST_NUM )AS SUB_AVG
        , (SELECT COUNT(SUB_NAME)  FROM test_subject WHERE TEST_NUM = TS.TEST_NUM) AS SUB_CNT
        FROM test_score TS
        INNER JOIN test TT
        ON TS.TEST_NUM= TT.TEST_NUM
        INNER JOIN test_subject TB
        ON TB.SUB_TEST_NUM=TS.SUB_TEST_NUM
        WHERE TS.TEST_NUM= #{testNum} AND TS.MEMBER_ID=#{memberId}
    </select>





</mapper>































